## Github Action 909: CI/CD Production vá»›i GitHub Actions

### Concept â€” Khi pipeline trá»Ÿ thÃ nh háº¡ táº§ng tháº­t

Khi chÃºng tÃ´i má»›i dá»±ng workflow Ä‘áº§u tiÃªn báº±ng GitHub Actions, má»i thá»© cÃ²n khÃ¡ ngáº«u há»©ng: má»—i repo cÃ³ má»™t YAML file riÃªng, Ä‘áº·t tÃªn theo cáº£m há»©ng, ai cáº§n gÃ¬ thÃ¬ thÃªm job Ä‘Ã³. NÃ³ cháº¡y Ä‘Æ°á»£c, build ra artifact, deploy lÃªn staging. NhÆ°ng vÃ i thÃ¡ng sau, khi sá»‘ service tÄƒng lÃªn hÆ¡n 20 vÃ  má»—i service cÃ³ vÃ i workflow, há»‡ thá»‘ng trá»Ÿ thÃ nh mÃª cung: khÃ´ng ai biáº¿t chÃ­nh xÃ¡c release flow cá»§a version nÃ o Ä‘ang cháº¡y á»Ÿ Ä‘Ã¢u, secret nÃ o Ä‘ang dÃ¹ng, hay ai vá»«a approve production.

LÃºc Ä‘Ã³ chÃºng tÃ´i nháº­n ra: pipeline CI/CD khÃ´ng chá»‰ lÃ  â€œchuá»—i jobâ€ ná»¯a. NÃ³ **lÃ  má»™t pháº§n cá»§a háº¡ táº§ng váº­n hÃ nh**. VÃ  náº¿u coi nÃ³ lÃ  háº¡ táº§ng, thÃ¬ nÃ³ pháº£i cÃ³ nhá»¯ng pháº©m cháº¥t cá»§a háº¡ táº§ng tháº­t â€” á»•n Ä‘á»‹nh, tÃ¡i sá»­ dá»¥ng, cÃ³ quan sÃ¡t, vÃ  cÃ³ kiá»ƒm soÃ¡t.

ChÃºng tÃ´i báº¯t Ä‘áº§u thiáº¿t káº¿ láº¡i tá»« gá»‘c:

* **Má»—i branch pháº£n Ã¡nh má»™t environment** â€“ `main` tÆ°Æ¡ng á»©ng staging, `production` lÃ  prod, cÃ²n feature branch thÃ¬ chá»‰ cháº¡y CI.
* **Má»—i environment cÃ³ chÃ­nh sÃ¡ch riÃªng:** secret tÃ¡ch biá»‡t, quyá»n deploy khÃ¡c nhau, vÃ  cáº§n manual approval trÆ°á»›c prod.
* **Má»i workflow Ä‘á»u cÃ³ owner, log, vÃ  trace.** KhÃ´ng cÃ³ â€œfile vÃ´ danhâ€ nÃ o cÃ²n Ä‘Æ°á»£c phÃ©p náº±m trong repo.

Tá»« Ä‘Ã³, chÃºng tÃ´i Ä‘á»‘i xá»­ vá»›i Actions nhÆ° vá»›i Terraform hay Kubernetes manifest â€” má»™t mÃ´ táº£ cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c, thay Ä‘á»•i cÃ³ thá»ƒ review vÃ  rollback Ä‘Æ°á»£c.

Äiá»u thÃº vá»‹ lÃ : khi mindset thay Ä‘á»•i, cÃ¡ch viáº¿t YAML cÅ©ng khÃ¡c. Ta khÃ´ng cÃ²n â€œcháº¡y cho xongâ€, mÃ  báº¯t Ä‘áº§u nghÄ© vá» **dÃ²ng cháº£y release â€“ release flow**. Má»—i workflow giá» cÃ³ input rÃµ rÃ ng, output Ä‘Æ°á»£c quáº£n lÃ½, cÃ³ version vÃ  cÃ³ cÃ¡ch promotion qua environment.

TÃ´i nghÄ© Ä‘Ã³ lÃ  Ä‘iá»ƒm chuyá»ƒn giao quan trá»ng nháº¥t: khi ta ngá»«ng coi Actions lÃ  â€œcÃ´ng cá»¥â€ vÃ  báº¯t Ä‘áº§u coi nÃ³ lÃ  â€œhá»‡ thá»‘ng váº­n hÃ nh mÃ£ nguá»“n má»Ÿâ€ cho CI/CD.

### Build â€” Blueprint thá»±c chiáº¿n cho CI/CD production

Khi báº¯t Ä‘áº§u thiáº¿t káº¿ láº¡i pipeline, chÃºng tÃ´i khÃ´ng cá»‘ â€œviáº¿t láº¡i toÃ n bá»™â€, mÃ  chá»n nguyÃªn táº¯c: *refactor báº±ng cÃ¡ch chuáº©n hÃ³a tá»«ng khá»‘i*.
ChÃºng tÃ´i tÃ¡ch toÃ n bá»™ quy trÃ¬nh thÃ nh ba táº§ng rÃµ rÃ ng â€” **branching & environment**, **reusable modules**, vÃ  **observability & rollback**. Má»—i táº§ng cÃ³ YAML riÃªng, má»—i YAML chá»‰ lÃ m má»™t viá»‡c, vÃ  cÃ³ thá»ƒ kiá»ƒm thá»­ Ä‘á»™c láº­p.

### 1. Branching & Environment Promotion

á» quy mÃ´ nhá», nhiá»u nhÃ³m chá»n cÃ¡ch deploy trá»±c tiáº¿p tá»« `main`. NhÆ°ng khi cÃ³ staging, pre-prod, vÃ  production, viá»‡c **phÃ¢n tÃ¡ch mÃ´i trÆ°á»ng báº±ng branch + environment** trá»Ÿ thÃ nh Ä‘iá»u báº¯t buá»™c.

ChÃºng tÃ´i Ä‘á»‹nh nghÄ©a rÃµ:

* `main` = staging
* `production` = mÃ´i trÆ°á»ng tháº­t
* má»i feature branch khÃ¡c chá»‰ cháº¡y CI (build + test)

Workflow tÆ°Æ¡ng á»©ng trÃ´ng nhÆ° sau:

```yaml
on:
  push:
    branches: [main, production]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build
        run: pnpm build

      - name: Deploy
        run: ./scripts/deploy.sh ${{ github.ref_name }}
```

LÃºc Ä‘áº§u, chÃºng tÃ´i khÃ´ng Ä‘á»ƒ Ã½ `environment:` lÃ  má»™t primitive ráº¥t máº¡nh. NÃ³ cho phÃ©p GitHub tá»± Ä‘á»™ng:

* táº¡o *secret scope riÃªng* cho tá»«ng mÃ´i trÆ°á»ng,
* cáº¥u hÃ¬nh *reviewer báº¯t buá»™c* trÆ°á»›c khi deploy,
* theo dÃµi *history* cá»§a tá»«ng environment.

Khi production cÃ³ sá»± cá»‘, chÃºng tÃ´i chá»‰ cáº§n má»Ÿ **Deployments** tab Ä‘á»ƒ biáº¿t version nÃ o, commit nÃ o, ai trigger vÃ  khi nÃ o. TrÆ°á»›c Ä‘Ã¢y pháº£i tra log thá»§ cÃ´ng; giá» chá»‰ vÃ i cÃº click.

Má»™t bÃ i há»c nhá»: *hÃ£y coi environment nhÆ° firewall tá»± nhiÃªn cá»§a há»‡ thá»‘ng CI/CD.* NÃ³ khÃ´ng ngÄƒn bug, nhÆ°ng ngÄƒn Ä‘Æ°á»£c bug lan ra production quÃ¡ nhanh.

### 2. Reusable Workflow & Compliance Checks

Khi sá»‘ workflow tÄƒng, YAML copy-paste trá»Ÿ thÃ nh Ã¡c má»™ng. ChÃºng tÃ´i chuyá»ƒn sang mÃ´ hÃ¬nh **reusable workflow**: má»—i chá»©c nÄƒng CI/CD chung (test, build, deploy, scan) Ä‘Æ°á»£c gom vÃ o `.github/workflows-core/`.

VÃ­ dá»¥, Ä‘Ã¢y lÃ  workflow `reusable-ci.yml` dÃ¹ng cho táº¥t cáº£ service Node.js:

```yaml
name: CI
on:
  workflow_call:
    inputs:
      node-version:
        required: true
        type: string

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
      - run: pnpm install
      - run: pnpm test
```

Khi dÃ¹ng láº¡i trong service cá»¥ thá»ƒ, chá»‰ cáº§n:

```yaml
jobs:
  ci:
    uses: org/workflows-core/.github/workflows/reusable-ci.yml@v2
    with:
      node-version: 20
```

Báº±ng cÃ¡ch nÃ y, chá»‰ cáº§n má»™t pull request vÃ o repo `workflows-core`, toÃ n bá»™ há»‡ thá»‘ng CI/CD Ä‘Æ°á»£c cáº­p nháº­t ngay. KhÃ´ng cÃ²n cáº£nh hÃ ng chá»¥c repo pháº£i sá»­a thá»§ cÃ´ng khi muá»‘n thÃªm step quÃ©t báº£o máº­t hoáº·c Ä‘á»•i version Node.

CÃ¹ng lÃºc Ä‘Ã³, chÃºng tÃ´i thÃªm má»™t táº§ng **compliance workflow**, vÃ­ dá»¥:

```yaml
jobs:
  security-scan:
    uses: org/workflows-core/.github/workflows/security-scan.yml@v1
  license-check:
    uses: org/workflows-core/.github/workflows/license-check.yml@v1
```

Má»¥c tiÃªu khÃ´ng pháº£i â€œbáº¯t lá»—iâ€, mÃ  Ä‘áº£m báº£o má»i repo Ä‘á»u tuÃ¢n theo **chuáº©n CI/CD tá»‘i thiá»ƒu**: cÃ³ test, cÃ³ scan, cÃ³ artifact traceable.

ChÃºng tÃ´i há»c Ä‘Æ°á»£c ráº±ng: khi workflow Ä‘Ã£ trá»Ÿ thÃ nh há»‡ thá»‘ng, chuáº©n hÃ³a khÃ´ng cÃ²n lÃ  lá»±a chá»n â€” nÃ³ lÃ  cÆ¡ cháº¿ tá»± vá»‡.

### 3. Audit, Observability & Rollback

Production pipeline mÃ  khÃ´ng cÃ³ rollback thÃ¬ cháº³ng khÃ¡c gÃ¬ deploy báº±ng cáº£m tÃ­nh.
ChÃºng tÃ´i táº¡o riÃªng má»™t workflow `rollback.yml`, cháº¡y thá»§ cÃ´ng qua `workflow_dispatch`:

```yaml
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version cáº§n rollback"
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: ./scripts/rollback.sh ${{ github.event.inputs.version }}
```

TÆ°á»Ÿng Ä‘Æ¡n giáº£n, nhÆ°ng chÃ­nh workflow nÃ y Ä‘Ã£ cá»©u chÃºng tÃ´i nhiá»u láº§n. Khi deploy gáº·p lá»—i, chá»‰ cáº§n vÃ o tab â€œActionsâ€, chá»n workflow `Rollback`, nháº­p version cÅ©, click â€œRunâ€. Má»i thá»© tá»± Ä‘á»™ng quay láº¡i tráº¡ng thÃ¡i an toÃ n.

Vá» **observability**, chÃºng tÃ´i tÃ­ch há»£p Slack webhook vÃ o táº¥t cáº£ pipeline. Báº¥t ká»³ khi nÃ o cÃ³ deploy, build fail, hay manual approval, Slack Ä‘á»u hiá»ƒn thá»‹ thÃ´ng tin dáº¡ng:

```text
ğŸ”” Deployment started
repo: api-gateway
env: production
commit: a1b2c3d
triggered by: @linh
```

Nhá» váº­y, CI/CD khÃ´ng cÃ²n lÃ  há»™p Ä‘en â€” nÃ³ trá»Ÿ thÃ nh dÃ²ng sá»± kiá»‡n liÃªn tá»¥c giá»¯a developer vÃ  há»‡ thá»‘ng.

Äáº¿n Ä‘Ã¢y, GitHub Actions khÃ´ng chá»‰ lÃ  YAML ná»¯a. NÃ³ Ä‘Ã£ trá»Ÿ thÃ nh **control plane cá»§a cáº£ release system**.

### Reflect â€” Äiá»u cÃ²n láº¡i sau khi há»‡ thá»‘ng cháº¡y á»•n

Sau gáº§n ná»­a nÄƒm tÃ¡i cáº¥u trÃºc toÃ n bá»™ pipeline, Ä‘iá»u thay Ä‘á»•i lá»›n nháº¥t khÃ´ng pháº£i á»Ÿ YAML, mÃ  á»Ÿ cÃ¡ch Ä‘á»™i ngÅ© nghÄ© vá» â€œreleaseâ€. TrÆ°á»›c Ä‘Ã¢y, má»—i láº§n merge lÃªn `main` lÃ  má»™t láº§n nÃ­n thá»Ÿ. Giá», má»i ngÆ°á»i yÃªn tÃ¢m hÆ¡n vÃ¬ má»—i báº£n phÃ¡t hÃ nh Ä‘á»u **cÃ³ lá»‹ch sá»­, cÃ³ chá»©ng cá»©, cÃ³ Ä‘Æ°á»ng lui**.

TÃ´i nháº­n ra: Ä‘á»ƒ CI/CD thá»±c sá»± â€œproduction-gradeâ€, báº¡n khÃ´ng cáº§n workflow phá»©c táº¡p, mÃ  cáº§n **tÆ° duy váº­n hÃ nh cÃ³ ká»· luáº­t**.

* Workflow chá»‰ lÃ  phÆ°Æ¡ng tiá»‡n, nhÆ°ng discipline má»›i lÃ  há»‡ Ä‘iá»u hÃ nh.
* YAML cÃ³ thá»ƒ viáº¿t láº¡i, nhÆ°ng traceability vÃ  consistency thÃ¬ pháº£i Ä‘Æ°á»£c gÃ¬n giá»¯ qua vÄƒn hÃ³a ká»¹ thuáº­t.
* CÃ²n automation, suy cho cÃ¹ng, chá»‰ giÃºp ta khÃ´ng láº·p láº¡i lá»—i cÅ© â€” nÃ³ khÃ´ng tá»± sinh ra sá»± trÆ°á»Ÿng thÃ nh.

ChÃºng tÃ´i tá»«ng máº¥t vÃ i tuáº§n chá»‰ Ä‘á»ƒ thá»‘ng nháº¥t cÃ¡ch Ä‘áº·t tÃªn job. NhÆ°ng sau khi chuáº©n hÃ³a, má»i ngÆ°á»i Ä‘á»c log cá»§a nhau dá»… hÆ¡n, debug nhanh hÆ¡n, vÃ  viá»‡c audit trá»Ÿ nÃªn Ä‘Æ¡n giáº£n nhÆ° Ä‘á»c lá»‹ch sá»­ commit.
Má»™t buá»•i post-mortem production outage tá»«ng kÃ©o dÃ i ba giá», giá» chá»‰ máº¥t mÆ°á»i phÃºt Ä‘á»ƒ truy ngÆ°á»£c: workflow nÃ o, commit nÃ o, ai approve, artifact nÃ o Ä‘Æ°á»£c deploy.

Khi há»‡ thá»‘ng Ä‘áº¡t Ä‘áº¿n Ä‘iá»ƒm Ä‘Ã³, báº¡n báº¯t Ä‘áº§u hiá»ƒu giÃ¡ trá»‹ tháº­t cá»§a CI/CD: **khÃ´ng pháº£i cháº¡y nhanh hÆ¡n, mÃ  lÃ  cháº¡y Ä‘Ãºng vÃ  cÃ³ thá»ƒ tin Ä‘Æ°á»£c.**

á» cuá»‘i hÃ nh trÃ¬nh, chÃºng tÃ´i viáº¿t ra má»™t checklist nhá» â€” thá»© mÃ  giá» tÃ´i coi nhÆ° â€œbá»™ luáº­t CI/CDâ€ riÃªng cá»§a Ä‘á»™i:

1. **Má»i thay Ä‘á»•i Ä‘á»u traceable.** (ai, khi nÃ o, commit nÃ o, environment nÃ o)
2. **Má»i mÃ´i trÆ°á»ng cÃ³ ranh giá»›i rÃµ rÃ ng.** (secrets, permission, approval riÃªng)
3. **Má»i workflow Ä‘á»u cÃ³ owner vÃ  log.**
4. **Rollback lÃ  workflow, khÃ´ng pháº£i hÆ°á»›ng dáº«n trong wiki.**
5. **KhÃ´ng deploy khi khÃ´ng ai biáº¿t ai chá»‹u trÃ¡ch nhiá»‡m.**

Nghe tÆ°á»Ÿng hiá»ƒn nhiÃªn, nhÆ°ng chÃ­nh nhá»¯ng Ä‘iá»u hiá»ƒn nhiÃªn Ä‘Ã³ quyáº¿t Ä‘á»‹nh Ä‘á»™ tin cáº­y cá»§a há»‡ thá»‘ng. 

Giá» nhÃ¬n láº¡i, GitHub Actions khÃ´ng chá»‰ giÃºp chÃºng tÃ´i â€œcháº¡y Ä‘Æ°á»£c pipelineâ€, mÃ  giÃºp chÃºng tÃ´i **nhÃ¬n tháº¥y há»‡ thá»‘ng cá»§a mÃ¬nh rÃµ hÆ¡n**. Tá»«ng job, tá»«ng artifact, tá»«ng approval Ä‘á»u trá»Ÿ thÃ nh dáº¥u váº¿t cá»§a sá»± minh báº¡ch.

VÃ  khi cÃ³ minh báº¡ch, báº¡n má»›i cÃ³ thá»ƒ cáº£i tiáº¿n.

Pháº§n nÃ y khÃ©p láº¡i series *GitHub Actions 101 â†’ 909*.
NhÆ°ng thá»±c ra, Ä‘Ã¢y má»›i lÃ  Ä‘iá»ƒm báº¯t Ä‘áº§u â€” nÆ¡i CI/CD trá»Ÿ thÃ nh **ná»n háº¡ táº§ng ká»¹ thuáº­t sá»‘ng**, cÃ²n workflow chá»‰ lÃ  cÃ¡ch báº¡n ká»ƒ láº¡i hÃ nh trÃ¬nh áº¥y báº±ng YAML.

## Kiá»ƒm tra kiáº¿n thá»©c

HÃ£y thá»­ lÃ m bÃ i quiz sau Ä‘Ã¢y Ä‘á»ƒ kiá»ƒm tra xem báº¡n Ä‘Ã£ náº¯m vá»¯ng cÃ¡c khÃ¡i niá»‡m vá» CI/CD Production vá»›i GitHub Actions chÆ°a:

<GitHubActionsPart9Quiz />