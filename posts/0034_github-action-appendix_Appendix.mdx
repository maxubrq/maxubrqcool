## Github Action Appendix: Bộ tài nguyên, ví dụ và template thực tế để audit, benchmark và hoàn thiện hệ thống CI/CD của bạn trước khi đưa vào vận hành thật

### 1. Repository mẫu — chạm vào thực tế

Ở giai đoạn đầu, tôi nhận ra nhiều kỹ sư hiểu cấu trúc workflow nhưng vẫn lúng túng khi bắt đầu. Vì vậy, chúng tôi tạo ra một bộ repo mẫu để bạn thử nghiệm trực tiếp:

* **`actions-demo-basic`** – ví dụ tối giản cho Node.js app: chạy `pnpm test`, build, rồi deploy staging.
* **`actions-demo-reusable`** – trình bày cách tách pipeline thành reusable workflow.
* **`actions-demo-secure`** – mô phỏng tình huống rò rỉ secrets và cách harden permission.
* **`actions-demo-observe`** – thêm alert, retry, rollback khi job fail.

Mỗi repo có `/.github/workflows/`, `docs/pipeline.md`, và `.env.example`. Cách tốt nhất để học là fork về, bật debug log (`ACTIONS_STEP_DEBUG=true`) rồi thử sửa. Chỉ cần chạy một pipeline và nhìn log, bạn sẽ hiểu rõ runner làm việc thế nào hơn cả đọc tài liệu.

### 2. Checklist kiểm tra CI/CD trước khi lên production

Chúng tôi từng audit hơn 20 repo có workflow “tưởng là ổn”. 80% trong số đó có ít nhất một lỗi nghiêm trọng về bảo mật hoặc reliability. Vì vậy, checklist này được đúc rút từ chính những lần “cháy thật”:

**Security**

* Không commit `.env` hoặc secrets vào repo.
* Giới hạn `permissions:` cho từng job, tránh `write-all`.
* Không dùng `pull_request_target` với public repo.
* Luôn review lại permission của reusable workflow.

**Reliability**

* Mỗi step critical nên có retry.
* Workflow fail phải bắn alert (Slack, Discord, PagerDuty).
* Validate input khi dùng `workflow_dispatch`.

**Performance**

* Dùng cache đúng scope (`restore-keys` hợp lý).
* Giảm số job trong matrix khi không cần thiết.
* Giữ artifact nhỏ gọn — chỉ upload cần thiết.

**Maintainability**

* Chia workflow theo chức năng (test/build/deploy).
* Có `README` mô tả logic pipeline.
* Dùng reusable workflow thay vì copy YAML giữa repo.

Checklist này nên được commit vào repo ở dạng file `ci_audit.yml` — coi như một phần của chính pipeline.

### 3. Template workflow — khởi đầu nhanh, chuẩn production

Ở nhiều tổ chức, tôi thấy các team bắt đầu CI/CD từ con số 0 mỗi lần khởi tạo project mới. Mỗi người lại copy một YAML từ đâu đó, sửa vội vài dòng, rồi để vậy. Sau vài tháng, pipeline phình to, logic trùng lặp, và không ai dám động vào nữa.
Vì thế, tôi tập hợp bốn template gốc — những khối xây dựng đủ linh hoạt để bạn tùy biến nhưng vẫn giữ kỷ luật.

**Template 1 — Monorepo build/test**
Dành cho dự án có nhiều package, chỉ chạy phần thay đổi:

```yaml
on:
  push:
    paths:
      - 'packages/**'
jobs:
  test:
    strategy:
      matrix:
        package: [core, api, web]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: pnpm install
      - run: pnpm --filter ${{ matrix.package }} test
```

Cách này tiết kiệm thời gian build tới 50–70% với repo lớn.

**Template 2 — Multi-environment deploy**
Triển khai qua ba môi trường có manual approval:

```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    steps: [...]
  staging:
    needs: build
    environment: staging
    steps: [...]
  production:
    needs: staging
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
      # yêu cầu manual approval trước khi deploy
```

Workflow này phản ánh mô hình thật mà hầu hết team CI/CD production đều dùng.

**Template 3 — Release automation**
Tự động tạo tag, changelog và publish package NPM hoặc Docker image.
**Template 4 — Security scan + SAST**
Dùng `CodeQL` hoặc `Trivy` quét mỗi PR, bảo đảm code an toàn trước merge.

### 4. Công cụ và tích hợp hữu ích

Không có workflow nào sống độc lập. Khi bạn đã vượt qua giai đoạn “chạy được”, phần tiếp theo là “quan sát được”.

* **Monitoring** – Datadog CI Visibility, NewRelic CI/CD Plugin, hoặc xuất log sang OpenTelemetry.
* **Secret & Vault** – tích hợp Doppler, 1Password CLI, hoặc HashiCorp Vault để tránh hardcoded secret.
* **Artifact Registry** – GitHub Packages, Artifactory, hoặc AWS ECR để lưu image, binary.
* **Policy & Compliance** – dùng OPA/Conftest để kiểm tra YAML trước khi merge.
* **Cost Optimization** – dùng GitHub Actions Insights hoặc script gọi `/usage` API để đo chi phí pipeline thực tế.

Một workflow ổn định là workflow “biết nói”: khi fail, nó nói vì sao; khi chạy chậm, nó cho bạn thấy chỗ nghẽn.

### 5. Hướng dẫn mở rộng và tự thiết kế workflow blueprint

Sau khi đã có nền, phần quan trọng nhất là *tùy biến theo domain* của chính bạn. Ở cấp tổ chức, việc sao chép YAML chỉ tạo ra nợ kỹ thuật; còn việc trừu tượng hóa thành blueprint giúp bạn kiểm soát và nâng cấp tập trung.

Cách chúng tôi làm ở một dự án lớn:

* Tách logic CI/CD theo domain: `frontend.yml`, `backend.yml`, `infra.yml`.
* Dùng **reusable workflow** trong repo riêng (`.github/workflows/_core.yml`) để chia sẻ logic build/test chung.
* Mỗi team chỉ override phần riêng (ví dụ `deploy` job).
* Gắn version cho reusable workflow (`@v3`) để audit được khi thay đổi.
* Duy trì **internal Actions Registry** – repo private chứa những action nội bộ như `notify-slack`, `validate-env`, `deploy-lambda`.

Khi cần phát hành cho nhiều môi trường, tôi thường kết hợp workflow của GitHub Actions với external orchestrator như **ArgoCD** hoặc **Terraform Cloud**. CI build → push artifact → CD nhận signal → deploy. Việc tách hai lớp giúp dễ rollback và giảm rủi ro khi Actions gặp sự cố.

Một **blueprint chuẩn production** thường có ba tầng:

1. **Foundation (101–303)**: hiểu event, runner, YAML.
2. **System (404–606)**: tối ưu pipeline, build matrix, security.
3. **Production (707–909)**: observability, self-healing, compliance.

### 6. Tài liệu tham khảo và nguồn học nâng cao

Khi gặp vấn đề, đừng chỉ tìm “cách làm” — hãy tìm “tại sao nó hoạt động như vậy”. Dưới đây là những tài nguyên đáng tin cậy:

* **Official Docs**

  * [GitHub Actions Documentation](https://docs.github.com/en/actions)
  * [Reusable Workflows](https://docs.github.com/en/actions/using-workflows/reusing-workflows)
* **Community**

  * [awesome-actions](https://github.com/sdras/awesome-actions)
* **Real-world Blueprints**

  * Google Cloud Build Samples
  * AWS CDK Pipelines Examples
  * GitHub Engineering Blog on Actions Infra

Nếu bạn muốn tiến xa hơn, hãy đọc log của chính GitHub Actions. Mỗi dòng `::debug::` kể lại câu chuyện thực sự của hệ thống.

### 7. Epilogue — tinh thần vận hành thực tế

Một pipeline tốt không cần hoa mỹ. Nó chỉ cần *đáng tin*.
Khi bạn trực đêm, thấy deploy fail nhưng workflow vẫn rollback đúng, cảm giác đó rất thật — như thể hệ thống đang “đứng cùng mình”.

Chúng tôi đã từng chạy hàng trăm pipeline mỗi ngày, có ngày runner chết, có ngày token hết hạn, có ngày cache hỏng. Nhưng chính những ngày ấy mới làm CI/CD trưởng thành.

Nếu có điều gì nên mang theo sau series này, thì đó là: **đừng coi CI/CD là công cụ**, hãy coi nó là *một phần của hệ thống sống*. Nó phản ánh cách đội của bạn làm việc, chia sẻ trách nhiệm, và tôn trọng người dùng.

Và nếu bạn bắt đầu hành trình riêng — hãy khởi đầu bằng một workflow thật, nhỏ, chạy được. Từ đó, bạn sẽ học được mọi thứ khác.
